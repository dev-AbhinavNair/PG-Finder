<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= pg.name %> - FindMyPG
    </title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <style>
        body {
            background: #f5f7fb;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: #2563eb;
            text-decoration: none;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: #2563eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
        }

        .gallery-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
            scroll-snap-type: x mandatory;
        }

        .gallery-container::-webkit-scrollbar {
            height: 8px;
        }

        .gallery-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .gallery-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .gallery-item {
            flex: 0 0 auto;
            width: 400px;
            height: 300px;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            scroll-snap-align: start;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .gallery-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #e5e7eb;
        }

        .gallery-item .zoom-hint {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .gallery-item:hover .zoom-hint {
            opacity: 1;
        }

        .gallery-placeholder {
            flex: 0 0 auto;
            width: 400px;
            height: 300px;
            border-radius: 16px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        @media (max-width: 768px) {

            .gallery-item,
            .gallery-placeholder {
                width: 300px;
                height: 220px;
            }
        }

        .lightbox-modal .modal-dialog {
            max-width: 90vw;
            margin: 1.75rem auto;
        }

        .lightbox-modal .modal-content {
            background: transparent;
            border: none;
        }

        .lightbox-modal .modal-body {
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-modal .lightbox-img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .lightbox-modal .btn-close {
            position: absolute;
            top: -40px;
            right: 0;
            filter: invert(1);
            opacity: 0.8;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .lightbox-nav:hover {
            background: #fff;
        }

        .lightbox-prev {
            left: -60px;
        }

        .lightbox-next {
            right: -60px;
        }

        @media (max-width: 768px) {
            .lightbox-prev {
                left: 10px;
            }

            .lightbox-next {
                right: 10px;
            }
        }

        .content-card {
            background: #fff;
            border-radius: 18px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            height: 100%;
        }

        .price-card {
            background: #fff;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 24px;
            border: 1px solid #e5e7eb;
        }

        .pg-title {
            font-weight: 800;
            color: #111827;
            font-size: 2rem;
            line-height: 1.2;
        }

        .pg-loc {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .amenity-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f3f4f6;
            border-radius: 12px;
            color: #374151;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .price-val {
            font-size: 2rem;
            font-weight: 800;
            color: #2563eb;
        }

        .gender-badge {
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .gender-boys {
            background: #dbeafe;
            color: #1e40af;
        }

        .gender-girls {
            background: #fce7f3;
            color: #9d174d;
        }

        .gender-mixed {
            background: #f3f4f6;
            color: #374151;
        }

        .section-head {
            font-weight: 700;
            margin-bottom: 16px;
            font-size: 1.25rem;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg bg-white border-bottom">
        <div class="container py-2">
            <a class="nav-brand" href="/">
                <span class="brand-icon">üè†</span>
                <span>FindMyPG</span>
            </a>

            <div class="ms-auto d-flex gap-2">
                <% if (user) { %>
                    <a href="/profile" class="btn btn-sm btn-outline-secondary">My Profile</a>
                    <% } else { %>
                        <a href="/login" class="btn btn-sm btn-outline-primary">Login</a>
                        <% } %>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="gallery-container">
            <% var allImages=[]; if (pg.cover_url) allImages.push(pg.cover_url); if (pg.gallery_urls &&
                pg.gallery_urls.length> 0) {
                pg.gallery_urls.forEach(function(url) { allImages.push(url); });
                }
                %>
                <% if (allImages.length> 0) { %>
                    <% allImages.forEach(function(url, index) { %>
                        <div class="gallery-item" data-bs-toggle="modal" data-bs-target="#lightboxModal"
                            data-index="<%= index %>">
                            <img src="<%= url %>" alt="Photo <%= index + 1 %>">
                            <!-- <span class="zoom-hint"><i class="bi bi-zoom-in me-1"></i>Click to zoom</span> -->
                        </div>
                        <% }); %>
                            <% } else { %>
                                <div class="gallery-placeholder">
                                    <span><i class="bi bi-image me-2"></i>No photos available</span>
                                </div>
                                <% } %>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="content-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h1 class="pg-title mb-1">
                                <%= pg.name %>
                            </h1>
                            <div class="pg-loc">
                                <i class="bi bi-geo-alt me-1"></i>
                                <%= pg.address_line %>, <%= pg.area %>, <%= pg.city %>
                            </div>
                        </div>

                        <span
                            class="gender-badge <%= pg.gender === 'boys' ? 'gender-boys' : pg.gender === 'girls' ? 'gender-girls' : 'gender-mixed' %>">
                            <%= pg.gender %> PG
                        </span>
                    </div>

                    <hr class="my-4 op-10">

                    <% if (pg.description) { %>
                        <div class="mb-5">
                            <div class="section-head">About this PG</div>
                            <p class="text-muted" style="line-height: 1.7;">
                                <%= pg.description %>
                            </p>
                        </div>
                        <% } %>

                            <div class="mb-5">
                                <div class="section-head">Amenities</div>
                                <div class="d-flex flex-wrap gap-2">
                                    <% if (pg.food_included) { %>
                                        <div class="amenity-pill"><i class="bi bi-egg-fried"></i> Food Included</div>
                                        <% } %>
                                            <% (pg.amenities || []).forEach(am=> { %>
                                                <div class="amenity-pill"><i class="bi bi-check-circle"></i>
                                                    <%= am %>
                                                </div>
                                                <% }) %>
                                </div>
                            </div>

                            <% if (pg.house_rules) { %>
                                <div class="mb-4">
                                    <div class="section-head">House Rules</div>
                                    <div class="p-3 bg-light rounded-3 text-muted">
                                        <%= pg.house_rules %>
                                    </div>
                                </div>
                                <% } %>

                </div>
            </div>

            <div class="col-lg-4">
                <div class="price-card">
                    <div class="text-muted mb-1">Starting from</div>
                    <div class="d-flex align-items-baseline mb-4">
                        <div class="price-val">‚Çπ<%= pg.min_price || pg.startingPrice %>
                        </div>
                        <span class="text-muted ms-1">/month</span>
                    </div>

                    <div class="d-grid gap-2">
                        <% if (user) { %>
                            <a href="/book/<%= pg._id %>" class="btn btn-primary btn-lg py-3 fw-bold shadow-sm">
                                Book Now
                            </a>
                            <% } else { %>
                                <a href="/login?redirect=/pgs/<%= pg._id %>"
                                    class="btn btn-primary btn-lg py-3 fw-bold shadow-sm">
                                    Login to Book
                                </a>
                                <div class="text-center mt-2 small text-muted">
                                    You need to login to view contact details
                                </div>
                                <% } %>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center"
                            style="width:48px;height:48px;">
                            <i class="bi bi-shield-check fs-4"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Verified Listing</div>
                            <div class="small text-muted">Inspected by FindMyPG team</div>
                        </div>
                    </div>

                    <% if (user) { %>
                        <div class="text-center">
                            <button type="button" class="btn btn-link text-muted btn-sm text-decoration-none"
                                data-bs-toggle="modal" data-bs-target="#reportModal">
                                <i class="bi bi-flag me-1"></i> Report this PG
                            </button>
                        </div>
                        <% } %>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form action="/pgs/<%= pg._id %>/report" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Report Listing</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small">Help us maintain a safe community. Reports are anonymous to the
                            owner.</p>
                        <div class="mb-3">
                            <label class="form-label">Reason for reporting</label>
                            <select class="form-select" name="reason" required>
                                <option value="">Select a reason</option>
                                <option value="incorrect_info">Incorrect Information</option>
                                <option value="bad_facilities">Bad Facilities</option>
                                <option value="harassment">Harassment / Bad Behavior</option>
                                <option value="inappropriate_content">Inappropriate Content</option>
                                <option value="safety_concern">Safety Concern</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-control" name="description" rows="3"
                                placeholder="Please provide more details..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger rounded-pill px-4">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="footer mt-5">
        <div class="container">
            <div class="text-center muted" style="font-size:.9rem;">
                ¬© <%= new Date().getFullYear() %> FindMyPG. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <div class="modal fade lightbox-modal" id="lightboxModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body position-relative">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <button type="button" class="lightbox-nav lightbox-prev" id="lightboxPrev">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <img src="" class="lightbox-img" id="lightboxImage" alt="Full size photo">
                    <button type="button" class="lightbox-nav lightbox-next" id="lightboxNext">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const allImages = [];
            <% 
            const imgUrls = [];
            if (pg.cover_url) imgUrls.push(pg.cover_url);
            if (pg.gallery_urls && pg.gallery_urls.length > 0) {
                pg.gallery_urls.forEach(url => imgUrls.push(url));
            }
            %>
            <% imgUrls.forEach(url => { %>
                allImages.push('<%= url %>');
            <% }); %>

                let currentIndex = 0;
            const lightboxImage = document.getElementById('lightboxImage');
            const lightboxPrev = document.getElementById('lightboxPrev');
            const lightboxNext = document.getElementById('lightboxNext');
            const lightboxModal = document.getElementById('lightboxModal');

            function showImage(index) {
                if (allImages.length === 0) return;
                currentIndex = (index + allImages.length) % allImages.length;
                lightboxImage.src = allImages[currentIndex];
            }

            lightboxModal.addEventListener('show.bs.modal', function (event) {
                const trigger = event.relatedTarget;
                const index = parseInt(trigger.getAttribute('data-index')) || 0;
                showImage(index);
            });

            lightboxPrev.addEventListener('click', function () {
                showImage(currentIndex - 1);
            });

            lightboxNext.addEventListener('click', function () {
                showImage(currentIndex + 1);
            });

            document.addEventListener('keydown', function (event) {
                if (!lightboxModal.classList.contains('show')) return;
                if (event.key === 'ArrowLeft') {
                    showImage(currentIndex - 1);
                } else if (event.key === 'ArrowRight') {
                    showImage(currentIndex + 1);
                }
            });
        })();
    </script>
</body>

</html>