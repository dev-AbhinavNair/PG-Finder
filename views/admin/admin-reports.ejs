<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FindMyPG Admin - Reports</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />


  <style>
    body { background:#f5f7fb; }

    .topbar {
      background:#ffffff;
      border-bottom: 1px solid #e5e7eb;
      height:56px;
    }
    .brand-link {
      display:flex; align-items:center; gap:10px;
      font-weight:700; color:#2563eb; text-decoration:none;
    }
    .brand-icon {
      width: 30px; height: 30px;
      border-radius: 10px;
      background:#2563eb;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:700;
    }

    .sidebar {
      background:#f9fafb;
      border-right:1px solid #e5e7eb;
      min-height: calc(100vh - 56px);
      padding: 14px 0;
    }
    .side-link {
      display:flex; align-items:center; gap:10px;
      padding: 9px 18px;
      color:#4b5563;
      text-decoration:none;
      font-size:.95rem;
    }
    .side-link:hover { background:#e5edff; }
    .side-link.active {
      background:#e5edff;
      color:#111827;
      border-left:3px solid #2563eb;
      padding-left: 15px;
      font-weight:600;
    }

    .content-wrap { padding: 18px 22px 32px; }
    .page-title { font-weight:700; font-size:1.35rem; color:#111827; }

    .stat-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background:#ffffff;
      padding: 12px 16px;
    }
    .stat-label { font-size:.8rem; color:#6b7280; }
    .stat-value { font-weight:700; font-size:1.3rem; }

    .filter-chip {
      border-radius: 999px;
      padding: 8px 12px;
      font-size:.85rem;
    }

    .table-card {
      background:#ffffff;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      overflow:hidden;
    }

    .badge-soft {
      border-radius:999px;
      padding:4px 10px;
      font-size:.75rem;
    }

    .badge-status-open {
      background:#fee2e2;
      color:#b91c1c;
    }
    .badge-status-under_review {
      background:#fef3c7;
      color:#92400e;
    }
    .badge-status-resolved {
      background:#dcfce7;
      color:#166534;
    }
    .badge-status-dismissed {
      background:#f3f4f6;
      color:#6b7280;
    }

    .badge-action-warning {
      background:#fef3c7;
      color:#92400e;
    }
    .badge-action-suspend {
      background:#fee2e2;
      color:#b91c1c;
    }
    .badge-action-ban {
      background:#7c2d12;
      color:#fff;
    }

    .modal-header {
      border-bottom: 1px solid #e5e7eb;
    }

    .footer {
      background:#ffffff;
      border-top:1px solid #e5e7eb;
      padding: 16px 24px;
      font-size:.85rem;
      color:#9ca3af;
    }
  </style>
</head>

<body>
  <nav class="navbar topbar px-3">
    <div class="container-fluid">
      <a class="brand-link" href="">
        <div class="brand-icon">A</div>
        <span>FindMyPG Admin</span>
      </a>

      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="small text-secondary d-none d-md-inline">
          <% if (admin && admin.name) { %>
            <%= admin.name %>
          <% } else { %>
            Admin
          <% } %>
        </span>
        <div class="rounded-circle bg-light border" style="width:32px;height:32px;overflow:hidden;">
          <% if (admin && admin.avatar_url) { %>
            <img src="<%= admin.avatar_url %>" style="width:100%;height:100%;object-fit:cover;" alt="avatar">
          <% } %>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row g-0">
      <aside class="col-12 col-md-3 col-lg-2 sidebar">
        <a href="/admin/listings" class="side-link">
          <span><i class="bi bi-list-ul"></i></span> Listings
        </a>
        <a href="/admin/reports" class="side-link active">
          <span><i class="bi bi-exclamation-triangle"></i></span> Reports
        </a>
        <a href="/admin/settings" class="side-link">
          <span><i class="bi bi-gear"></i></span> Settings
        </a>

        <form action="/logout" method="POST" class="mt-3 px-3">
          <button class="btn btn-outline-secondary btn-sm w-100" type="submit">Logout</button>
        </form>
      </aside>

      <main class="col-12 col-md-9 col-lg-10 content-wrap">
        <h4 class="page-title mb-3">User Reports & Moderation</h4>

        <div class="row g-3 mb-4">
          <div class="col-6 col-md-4">
            <div class="stat-card">
              <div class="stat-label">Open Reports</div>
              <div class="stat-value"><%= stats ? stats.open : 0 %></div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="stat-card">
              <div class="stat-label">Resolved</div>
              <div class="stat-value"><%= stats ? stats.resolved : 0 %></div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="stat-card">
              <div class="stat-label">Total Reports</div>
              <div class="stat-value"><%= stats ? stats.total : 0 %></div>
            </div>
          </div>
        </div>

        <div class="row g-2 align-items-center mb-3">
          <div class="col-12">
            <div class="d-flex gap-2 flex-wrap">
              <a href="/admin/reports?status=all" class="btn btn-outline-secondary filter-chip <%= currentStatus === 'all' ? 'active' : '' %>">All</a>
              <a href="/admin/reports?status=open" class="btn btn-outline-danger filter-chip <%= currentStatus === 'open' ? 'active' : '' %>">Open</a>
              <a href="/admin/reports?status=under_review" class="btn btn-outline-warning filter-chip <%= currentStatus === 'under_review' ? 'active' : '' %>">Under Review</a>
              <a href="/admin/reports?status=resolved" class="btn btn-outline-success filter-chip <%= currentStatus === 'resolved' ? 'active' : '' %>">Resolved</a>
            </div>
          </div>
        </div>

        <div class="table-card">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>PG Name</th>
                  <th>Owner</th>
                  <th>Reported By</th>
                  <th>Reason</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Action Taken</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
                <% if (!reports || reports.length === 0) { %>
                  <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                      No reports found.
                    </td>
                  </tr>
                <% } %>

                <% (reports || []).forEach(r => { %>
                  <tr>
                    <td>
                      <div class="fw-semibold"><%= r.pgName %></div>
                      <div class="small text-muted"><%= r.pgArea %>, <%= r.pgCity %></div>
                    </td>
                    <td>
                      <div class="fw-semibold"><%= r.pgOwner %></div>
                      <div class="small text-muted"><%= r.ownerPhone %></div>
                    </td>
                    <td>
                      <div class="fw-semibold"><%= r.reportedBy %></div>
                      <div class="small text-muted"><%= r.reporterPhone %></div>
                    </td>
                    <td>
                      <span class="text-capitalize"><%= r.reason.replace(/_/g, ' ') %></span>
                      <div class="small text-muted mt-1"><%= r.description.substring(0, 50) %><% if (r.description.length > 50) { %>...<% } %></div>
                    </td>
                    <td><%= r.reportedAtFormatted %></td>
                    <td>
                      <% const st = r.status; %>
                      <span class="badge-soft badge-status-<%= st %>">
                        <%= st.charAt(0).toUpperCase() + st.slice(1).replace(/_/g, ' ') %>
                      </span>
                    </td>
                    <td>
                      <% if (r.adminAction !== 'none') { %>
                        <span class="badge-soft badge-action-<%= r.adminAction %>">
                          <%= r.adminAction.charAt(0).toUpperCase() + r.adminAction.slice(1) %>
                        </span>
                      <% } else { %>
                        <span class="small text-muted">—</span>
                      <% } %>
                    </td>
                    <td class="text-end">
                      <% if (r.status === 'open' || r.status === 'under_review') { %>
                        <a href="/admin/reports/<%= r._id %>" class="btn btn-sm btn-outline-primary">View</a>
                      <% } else { %>
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#viewModal" onclick="viewReport('<%= r._id %>', '<%= r.adminNotes %>'); return false;">View</button>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-center px-3 py-2 border-top small text-muted">
            <span>Page <%= page || 1 %> of <%= totalPages || 1 %></span>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item <%= (page || 1) <= 1 ? 'disabled' : '' %>">
                  <a class="page-link" href="?status=<%= currentStatus %>&page=<%= (page || 1) - 1 %>">Previous</a>
                </li>
                <li class="page-item <%= (page || 1) >= (totalPages || 1) ? 'disabled' : '' %>">
                  <a class="page-link" href="?status=<%= currentStatus %>&page=<%= (page || 1) + 1 %>">Next</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Resolve Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Action</label>
            <select class="form-select" id="actionType">
              <option value="">-- Select Action --</option>
              <option value="warning">Send Warning</option>
              <option value="temporary">Suspend Listing (30 days)</option>
              <option value="permanent">Ban Listing</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Admin Notes</label>
            <textarea class="form-control" id="adminNotes" rows="4" placeholder="Enter reason for action..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitAction()">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Resolution Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="viewNotes"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer text-center">
    © <%= new Date().getFullYear() %> FindMyPG Admin. All rights reserved.
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentReportId = null;

    function setReportId(id) {
      currentReportId = id;
    }

    function viewReport(id, notes) {
      document.getElementById('viewNotes').textContent = notes || 'No notes provided';
    }

    async function submitAction() {
      const actionType = document.getElementById('actionType').value;
      const adminNotes = document.getElementById('adminNotes').value;

      if (!actionType) {
        alert('Please select an action');
        return;
      }

      try {
        let url, body;

        if (actionType === 'warning') {
          url = `/admin/reports/${currentReportId}/warn`;
          body = { notes: adminNotes };
        } else {
          url = `/admin/reports/${currentReportId}/ban`;
          body = { banType: actionType, notes: adminNotes };
        }

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (res.ok) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (err) {
        alert('Request failed: ' + err.message);
      }
    }
  </script>

</body>
</html>
