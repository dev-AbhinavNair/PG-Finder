<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" type="image/png" href="/media/favIcon.png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FindMyPG Owner - Edit PG</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <style>
        body {
            background: #f5f7fb;
        }

        .topbar {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        .brand-dot {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #0ea5a4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
        }

        .sidebar {
            background: #f3f4f6;
            border-right: 1px solid #e5e7eb;
            min-height: calc(100vh - 56px);
            padding: 14px 10px;
        }

        .side-link {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #374151;
            text-decoration: none;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: .95rem;
        }

        .side-link:hover {
            background: #e9eefb;
        }

        .side-link.active {
            background: #e9eefb;
            color: #111827;
            font-weight: 600;
        }

        .side-ic {
            width: 18px;
            height: 18px;
            opacity: .75;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .content-wrap {
            padding: 18px 18px 28px;
        }

        .page-title {
            font-weight: 700;
            font-size: 1.4rem;
            color: #111827;
        }

        .muted {
            color: #6b7280;
        }

        .help {
            font-size: .85rem;
            color: #6b7280;
        }

        .card-soft {
            border: 0;
            border-radius: 14px;
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
            background: #fff;
        }

        .req::after {
            content: " *";
            color: #ef4444;
            font-weight: 700;
        }

        .form-control,
        .form-select {
            border-radius: 12px;
        }

        .cover-preview {
            width: 100%;
            height: 160px;
            border-radius: 14px;
            overflow: hidden;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
        }

        .cover-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .footer {
            color: #9ca3af;
            font-size: .85rem;
            padding: 18px;
            border-top: 1px solid #e5e7eb;
            background: #fff;
        }

        .sidebar-overlay {
            display: none;
        }

        @media (max-width: 991.98px) {
            .sidebar {
                position: fixed;
                top: 56px;
                bottom: 0;
                left: 0;
                width: 260px;
                transform: translateX(-100%);
                z-index: 1040;
                transition: transform 0.3s ease-in-out;
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: block;
                position: fixed;
                top: 56px;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.4);
                z-index: 1030;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s;
            }

            .sidebar-overlay.show {
                opacity: 1;
                visibility: visible;
            }
        }

        code.badge-like {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: .8rem;
            color: #374151;
        }
    </style>
</head>

<body>
    <nav class="navbar topbar navbar-expand-lg px-3" style="height:56px;">
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-light d-lg-none me-2" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
            <div class="brand-dot">üè†</div>
            <span class="fw-semibold" style="color:#0f766e;">FindMyPG Owner</span>
        </div>

        <div class="ms-auto d-flex align-items-center gap-3">
            <% if (typeof owner !=="undefined" && owner) { %>
                <span class="small text-secondary d-none d-md-inline">Hi, <%= owner.name %></span>
                <% } %>

                    <div class="rounded-circle bg-light border" style="width:34px;height:34px; overflow:hidden;">
                        <% if (typeof owner !=="undefined" && owner && owner.avatar_url) { %>
                            <img src="<%= owner.avatar_url %>" alt="avatar"
                                style="width:100%;height:100%;object-fit:cover;">
                            <% } %>
                    </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row g-0">
            <aside class="col-12 col-md-3 col-lg-2 sidebar">
                <a class="side-link active" href="/owner">
                    <span class="side-ic">‚ñ¶</span> My PGs
                </a>
                <a class="side-link" href="/owner/pg/new">
                    <span class="side-ic">Ôºã</span> Add New PG
                </a>
                <a class="side-link" href="/owner/bookings">
                    <span class="side-ic">üóì</span> Bookings
                </a>
                <a class="side-link" href="/owner/messages">
                    <span class="side-ic">üí¨</span> Messages
                </a>
                <a class="side-link" href="/owner/payouts">
                    <span class="side-ic">‚Çπ</span> Payouts
                </a>
                <a class="side-link" href="/owner/settings">
                    <span class="side-ic"><i class="bi bi-gear"></i></span> Settings
                </a>

                <form action="/logout" method="POST" class="mt-3 px-2">
                    <button class="btn btn-outline-secondary w-100 btn-sm" type="submit">Logout</button>
                </form>
            </aside>
            <div class="sidebar-overlay" id="sidebarOverlay"></div>

            <main class="col-12 col-md-9 col-lg-10 content-wrap">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                        <div class="page-title">Edit PG</div>
                        <div class="muted small">
                            Update details for <span class="fw-semibold">
                                <%= pg.name %>
                            </span>
                            <% if (pg.status) { %>
                                ¬∑ <span class="ms-1">Status:</span> <code class="badge-like"><%= pg.status %></code>
                                <% } %>
                        </div>
                    </div>

                    <a href="/owner" class="btn btn-outline-secondary btn-sm" style="border-radius: 12px;">
                        Back
                    </a>
                </div>

                <% if (typeof error !=="undefined" && error) { %>
                    <div class="alert alert-danger border">
                        <%= error %>
                    </div>
                    <% } %>

                        <form action="/owner/pg/<%= pg._id %>/edit" method="POST" enctype="multipart/form-data">
                            <div class="card card-soft">
                                <div class="card-body p-3 p-md-4">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Current cover photo</label>
                                            <div class="cover-preview">
                                                <% const cover=pg.coverUrl || pg.cover_url || null; %>
                                                    <% if (cover) { %>
                                                        <img src="<%= cover %>" alt="Cover photo">
                                                        <% } %>
                                            </div>
                                            <div class="help mt-1">Upload new photos below if you want to change the
                                                cover.</div>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label req">PG Name</label>
                                            <input class="form-control" name="name" required
                                                value="<%= pg.name || '' %>" />
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">Short tagline</label>
                                            <input class="form-control" name="short_tagline"
                                                value="<%= pg.short_tagline || pg.shortTagline || '' %>" />
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <label class="form-label req">Address line</label>
                                            <input class="form-control" name="address_line" required
                                                value="<%= pg.address_line || pg.addressLine || '' %>" />
                                        </div>

                                        <div class="col-6 col-lg-3">
                                            <label class="form-label req">Area</label>
                                            <input class="form-control" name="area" required
                                                value="<%= pg.area || '' %>" />
                                        </div>

                                        <div class="col-6 col-lg-3">
                                            <label class="form-label req">City</label>
                                            <input class="form-control" name="city" required
                                                value="<%= pg.city || '' %>" />
                                        </div>

                                        <div class="col-6 col-lg-3">
                                            <label class="form-label">State</label>
                                            <input class="form-control" name="state" value="<%= pg.state || '' %>" />
                                        </div>

                                        <div class="col-6 col-lg-3">
                                            <label class="form-label">Pincode</label>
                                            <input class="form-control" name="pincode"
                                                value="<%= pg.pincode || '' %>" />
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <label class="form-label">Gender type</label>
                                            <% const g=(pg.gender || 'mixed' ); %>
                                                <select class="form-select" name="gender">
                                                    <option value="mixed" <%=g==="mixed" ? "selected" : "" %>>Mixed
                                                    </option>
                                                    <option value="boys" <%=g==="boys" ? "selected" : "" %>>Boys
                                                    </option>
                                                    <option value="girls" <%=g==="girls" ? "selected" : "" %>>Girls
                                                    </option>
                                                </select>
                                        </div>

                                        <div class="col-12 col-lg-6 d-flex align-items-end">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="food_included"
                                                    name="food_included" <%=pg.food_included ? "checked" : "" %> />
                                                <label class="form-check-label" for="food_included">Food
                                                    included</label>
                                            </div>
                                        </div>

                                        <div class="col-6 col-lg-3">
                                            <label class="form-label">Min price (‚Çπ)</label>
                                            <input class="form-control" name="min_price" type="number" min="0"
                                                value="<%= (pg.min_price ?? pg.minPrice ?? '') %>" />
                                        </div>

                                        <div class="col-6 col-lg-3">
                                            <label class="form-label">Max price (‚Çπ)</label>
                                            <input class="form-control" name="max_price" type="number" min="0"
                                                value="<%= (pg.max_price ?? pg.maxPrice ?? '') %>" />
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <label class="form-label">Amenities (comma separated)</label>
                                            <% const amen=Array.isArray(pg.amenities) ?
                                                pg.amenities.join(", ") : (pg.amenities || ""); %>
                  <input class=" form-control" name="amenities" placeholder="WiFi, Parking, Power backup"
                                                value="<%= amen %>" />
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" name="description"
                                                rows="3"><%= pg.description || '' %></textarea>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">Long description</label>
                                            <textarea class="form-control" name="long_description"
                                                rows="5"><%= pg.long_description || pg.longDescription || '' %></textarea>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">House rules</label>
                                            <textarea class="form-control" name="house_rules"
                                                rows="3"><%= pg.house_rules || pg.houseRules || '' %></textarea>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">Add / replace photos</label>
                                            <input class="form-control" type="file" name="photos" accept="image/*"
                                                multiple />
                                            <div class="help mt-1">
                                                If you upload new photos, update logic can either (a) append to gallery
                                                or (b) replace gallery.
                                                Decide in the POST route.
                                            </div>
                                        </div>

                                        <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                                            <a href="/owner" class="btn btn-outline-secondary"
                                                style="border-radius: 12px;">Cancel</a>
                                            <button class="btn btn-success px-4" type="submit"
                                                style="border-radius: 12px;">
                                                Save changes
                                            </button>
                                            <button type="button" class="btn btn-danger px-4" id="deleteBtn"
                                                style="border-radius: 12px;">
                                                Delete PG
                                            </button>
                                        </div>

                                        <% const gallery=pg.gallery_urls || []; %>

                                            <div class="col-12">
                                                <label class="form-label">Current photos</label>

                                                <% if (!gallery.length) { %>
                                                    <div class="muted small">No photos uploaded yet.</div>
                                                    <% } else { %>
                                                        <div class="row g-2">
                                                            <% gallery.forEach((u, idx)=> { %>
                                                                <div class="col-6 col-md-4 col-lg-3">
                                                                    <div class="card border-0"
                                                                        style="border-radius:12px; overflow:hidden; box-shadow: 0 6px 18px rgba(15,23,42,.08);">
                                                                        <div style="height:110px; background:#e5e7eb;">
                                                                            <img src="<%= u %>"
                                                                                alt="pg-photo-<%= idx %>"
                                                                                style="width:100%;height:100%;object-fit:cover;display:block;">
                                                                        </div>

                                                                        <div class="p-2 bg-white border-top">
                                                                            <div class="form-check mb-1">
                                                                                <input class="form-check-input"
                                                                                    type="checkbox" name="removePhotos"
                                                                                    value="<%= u %>" id="rm_<%= idx %>">
                                                                                <label class="form-check-label small"
                                                                                    for="rm_<%= idx %>">Remove</label>
                                                                            </div>

                                                                            <div class="form-check">
                                                                                <input class="form-check-input"
                                                                                    type="radio" name="coverPhoto"
                                                                                    value="<%= u %>" id="cv_<%= idx %>"
                                                                                    <%=((pg.coverUrl ||
                                                                                    pg.cover_url)===u) ? "checked" : ""
                                                                                    %>>
                                                                                <label class="form-check-label small"
                                                                                    for="cv_<%= idx %>">Set as
                                                                                    cover</label>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <% }) %>
                                                        </div>

                                                        <div class="help mt-2">
                                                            Tick ‚ÄúRemove‚Äù for photos you want to delete, optionally pick
                                                            a new cover, then click ‚ÄúSave changes‚Äù.
                                                        </div>
                                                        <% } %>
                                            </div>

                                            <div class="col-12">
                                                <div class="alert alert-light border mb-0 small muted">
                                                    Tip: after editing, you can re-submit for approval (if you use a
                                                    pending approval workflow).
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="footer text-center mt-4">
                            <%= new Date().getFullYear() %> FindMyPG Owner. All rights reserved.
                        </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('deleteBtn').addEventListener('click', function () {
            if (confirm('Are you sure you want to delete this PG? This cannot be undone.')) {
                if (confirm('This will permanently delete this PG listing. Continue?')) {
                    const btn = this;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
                    btn.disabled = true;

                    fetch('/owner/pg/<%= pg._id %>/delete', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = '/owner?success=PG deleted successfully';
                            } else {
                                alert('Error: ' + (data.error || 'Failed to delete'));
                                btn.innerHTML = 'Delete PG';
                                btn.disabled = false;
                            }
                        })
                        .catch(err => {
                            alert('Error: ' + err.message);
                            btn.innerHTML = 'Delete PG';
                            btn.disabled = false;
                        });
                }
            }
        });

        document.addEventListener('submit', (e) => {
            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            if (btn && !form.hasAttribute('data-no-loading')) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                btn.disabled = true;

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 500);
            }
        });

        const toggleBtn = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (toggleBtn && sidebar && overlay) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
            });

            overlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            });
        }
    </script>

</body>

</html>